import{X as te,Y as ae,bg as Q,ak as le,Z as se,a4 as re,bh as oe,v as l,f as ne,n as ie,bi as ue,b2 as de,ar as ce,b7 as me,bj as ve,h as R,H as G,ad as J,g as m,w as L,m as U,o as c,s,R as pe,S as fe,B as K,b as o,P as ge,D as x,bk as ye,Q as H,V as F,x as z,c as k,F as O,e as E,ag as _e,ah as Ve,y as w,a as W,C,U as be,aO as xe,_ as ee,bd as X,T as q,a7 as Y,aD as B,k as we,i as ke,E as A,t as De}from"./index-Cy3rsmT0.js";import{r as N,V as he}from"./review-CSAC3hnc.js";import{V as Pe}from"./VTextarea-BUJIg8dx.js";import{V as Z,a as Se}from"./VDatePicker-Cj6Pi2f1.js";import{o as Ce}from"./order-CW6NRgji.js";import"./VPagination-BJTO1oki.js";import"./VSelect-CSisNt0d.js";import"./VCheckboxBtn-UyNAd-A7.js";import"./VChip-yjxMPXwl.js";import"./VTable-C3pbqSVz.js";const Ie=ae({modelValue:Boolean,options:{type:Object,default:()=>({root:void 0,rootMargin:void 0,threshold:void 0})},...me(),...ce(),...de(),...ue({transition:"fade-transition"})},"VLazy"),Te=te()({name:"VLazy",directives:{vIntersect:Q},props:Ie(),emits:{"update:modelValue":v=>!0},setup(v,I){let{slots:y}=I;const{dimensionStyles:T}=le(v),_=se(v,"modelValue");function p(n){_.value||(_.value=n)}return re(()=>oe(l(v.tag,{class:ie(["v-lazy",v.class]),style:ne([T.value,v.style])},{default:()=>[_.value&&l(ve,{transition:v.transition,appear:!0},{default:()=>{var n;return[(n=y.default)==null?void 0:n.call(y)]}})]}),[[Q,{handler:p,options:v.options},null]])),{}}}),$e={class:"full-width d-flex justify-space-between align-center px-4 mt-4"},Ue=["onClick"],Re={class:"flex-grow-1"},Me={class:"text-h6"},ze={class:"text-subtitle-2 text-medium-emphasis"},Le={class:"mt-4"},Oe={class:"d-flex align-center flex-wrap"},je={__name:"orderAddDialog",props:{modelValue:{type:Boolean,required:!0},orderId:{type:String,required:!0},orderProducts:{type:Array,required:!0}},emits:["update:modelValue","submit-success"],setup(v,{emit:I}){const y=v,T=I,_=R({get:()=>y.modelValue,set:t=>T("update:modelValue",t)}),p=G(),n=J(),u=m(!1),f=m(!1),V=m(!1),d=m({}),D=m({}),h=()=>{for(const t of y.orderProducts)d.value[t.product._id]={rating:0,review:"",reviewId:null,isReviewed:!1}},M=(t,e)=>{var a;return((a=D.value[t])==null?void 0:a[e])||[]},$=()=>{const t={};let e=!0;for(const[a,r]of Object.entries(d.value))t[a]={},r.review.length>500&&(t[a].review=["評論最多500字"],e=!1);return D.value=t,e},P=()=>{h(),D.value={},u.value=!1,f.value=!1},b=()=>{_.value=!1,P()},g=t=>{t==="monetary"?(u.value=!u.value,f.value=!1):t==="emotional"&&(f.value=!f.value,u.value=!1)};L([()=>y.modelValue,()=>y.orderProducts],async([t,e])=>{if(t&&e.length>0){h();for(const a of e)try{const{data:r}=await N.getReviewsByProductId(a.product._id),S=r.result.find(j=>j.userId._id===n.id);S&&(d.value[a.product._id].rating=S.rating,d.value[a.product._id].review=S.content,d.value[a.product._id].reviewId=S._id,d.value[a.product._id].isReviewed=!0)}catch(r){console.error(`Error fetching review for product ${a.product._id}:`,r)}}},{immediate:!0});const i=async()=>{var t,e;if(!$()){p({text:"請檢查評論內容",snackbarProps:{color:"warning"}});return}V.value=!0;try{const a=Object.entries(d.value).map(([r,S])=>{const j={rating:S.rating,content:S.review,orderId:y.orderId,monetaryTip:u.value,emotionalCompensation:f.value};return S.reviewId?N.updateReview(r,S.reviewId,j):N.addReview(r,j)});await Promise.all(a),p({text:"評價成功！",snackbarProps:{color:"success"}}),b(),T("submit-success")}catch(a){console.error("Error submitting reviews:",a),p({text:((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.message)||"評價失敗，請稍後再試",snackbarProps:{color:"error"}})}finally{V.value=!1}};return(t,e)=>(c(),U(xe,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=a=>_.value=a),fullscreen:"",transition:"dialog-bottom-transition"},{default:s(()=>[l(pe,{class:"h-100",disabled:V.value,onSubmit:fe(i,["prevent"])},{default:s(()=>[l(K,{class:"text-text"},{default:s(()=>[o("div",$e,[l(ge,{class:"text-accent"},{default:s(()=>e[3]||(e[3]=[x(" 訂單評價 ")])),_:1,__:[3]}),l(ye,{class:"text-nav"},{default:s(()=>e[4]||(e[4]=[x("訂單編號")])),_:1,__:[4]})]),l(H,null,{default:s(()=>[l(F,{class:"px-4 mt-0","no-gutters":""},{default:s(()=>[l(z,{cols:"12"},{default:s(()=>[(c(!0),k(O,null,E(v.orderProducts,a=>(c(),k("div",{key:a.product._id,class:"mb-6"},[o("div",{class:"d-flex align-items-start mb-2 cursor-pointer",onClick:r=>(a==null?void 0:a.product)&&t.$router.push("/product/"+a.product._id)},[l(_e,{class:"mr-4",rounded:"0",size:"80"},{default:s(()=>{var r;return[l(Ve,{cover:"",src:((r=a==null?void 0:a.product)==null?void 0:r.image)||""},null,8,["src"])]}),_:2},1024),o("div",Re,[o("h3",Me,w(a.product.name),1),o("p",ze,w(a.product.description),1)])],8,Ue),o("div",Le,[e[5]||(e[5]=o("span",{class:"text-body-1 font-weight-bold mb-2 d-block"},"情感滿意度",-1)),e[6]||(e[6]=o("span",{class:"text-caption text-no-wrap d-block mb-2"},"一星最低五星最高",-1)),l(he,{modelValue:d.value[a.product._id].rating,"onUpdate:modelValue":r=>d.value[a.product._id].rating=r,color:"highlight1","error-messages":M(a.product._id,"rating"),hover:"",size:"40"},null,8,["modelValue","onUpdate:modelValue","error-messages"])]),l(Pe,{modelValue:d.value[a.product._id].review,"onUpdate:modelValue":r=>d.value[a.product._id].review=r,class:"mt-4",counter:"500","error-messages":M(a.product._id,"review"),label:"分享您對此商品的感受",rows:"3",rules:[r=>r.length<=500||"評論最多500字"],variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","error-messages","rules"])]))),128))]),_:1}),l(z,{cols:"12"},{default:s(()=>[e[10]||(e[10]=o("p",{class:"text-h6 mb-2"},"額外選項",-1)),o("div",Oe,[l(C,{class:"mr-2 mb-2",color:u.value?"primary":"grey",variant:"outlined",onClick:e[0]||(e[0]=a=>g("monetary"))},{default:s(()=>e[7]||(e[7]=[x(" 金錢打賞 ")])),_:1,__:[7]},8,["color"]),l(C,{class:"mr-2 mb-2",color:f.value?"primary":"grey",variant:"outlined",onClick:e[1]||(e[1]=a=>g("emotional"))},{default:s(()=>e[8]||(e[8]=[x(" 精神賠償 ")])),_:1,__:[8]},8,["color"]),f.value?(c(),U(H,{key:0},{default:s(()=>e[9]||(e[9]=[o("p",{class:"text-body-2 text-error"},"購買後發現不符自己需求，僅退回部分情緒幣",-1)])),_:1,__:[9]})):W("",!0)])]),_:1,__:[10]})]),_:1})]),_:1}),l(be,null,{default:s(()=>[l(F,{class:"px-3 mb-4","no-gutters":""},{default:s(()=>[l(z,{class:"d-flex justify-end pt-1",cols:"12"},{default:s(()=>[l(C,{class:"text-primary",disabled:V.value,onClick:b},{default:s(()=>e[11]||(e[11]=[x(" 取消 ")])),_:1,__:[11]},8,["disabled"]),l(C,{class:"text-accent",loading:V.value,type:"submit",variant:"flat"},{default:s(()=>e[12]||(e[12]=[x(" 確認 ")])),_:1,__:[12]},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled"])]),_:1},8,["modelValue"]))}},Ae={class:"sticky-top"},Ee={class:"d-flex align-center"},Be={__name:"orderTop",props:{search:{type:String,default:""}},emits:["update:search","search"],setup(v,{emit:I}){const y=v,T=I,_=m(!1),p=m(!1),n=m(null),u=m(null),f=m(y.search),V=m(null),d=m(null);L(n,g=>{V.value=g},{immediate:!0}),L(u,g=>{d.value=g},{immediate:!0});const D=R(()=>n.value&&u.value&&new Date(n.value)>new Date(u.value)?["開始日期不能晚於結束日期"]:[]),h=g=>{n.value=g,_.value=!1,b()},M=g=>{u.value=g,p.value=!1,b()};L(()=>f.value,()=>b()),L(()=>[n.value,u.value],()=>b());const $=R(()=>n.value?new Date(n.value).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}):""),P=R(()=>u.value?new Date(u.value).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}):""),b=()=>{D.value.length>0||T("search",{search:f.value,startDate:n.value?new Date(n.value):null,endDate:u.value?new Date(u.value):null})};return(g,i)=>(c(),k("div",Ae,[l(F,{"no-gutters":""},{default:s(()=>[l(z,{class:"pa-4",cols:"12",md:"6"},{default:s(()=>[o("div",Ee,[l(X,{modelValue:_.value,"onUpdate:modelValue":i[2]||(i[2]=t=>_.value=t),"close-on-content-click":!1,location:"bottom left",transition:"scale-transition"},{activator:s(({props:t})=>[l(q,Y({modelValue:$.value,"onUpdate:modelValue":i[0]||(i[0]=e=>$.value=e),density:"compact"},t,{"error-messages":D.value,"hide-details":"",label:"開始日期","prepend-inner-icon":"mdi-calendar",readonly:"",variant:"outlined"}),null,16,["modelValue","error-messages"])]),default:s(()=>[l(Z,{modelValue:V.value,"onUpdate:modelValue":[i[1]||(i[1]=t=>V.value=t),h],"first-day-of-week":1,max:d.value},null,8,["modelValue","max"])]),_:1},8,["modelValue"]),i[7]||(i[7]=o("span",{class:"mx-2"},"~",-1)),l(X,{modelValue:p.value,"onUpdate:modelValue":i[5]||(i[5]=t=>p.value=t),"close-on-content-click":!1,location:"bottom left",transition:"scale-transition"},{activator:s(({props:t})=>[l(q,Y({modelValue:P.value,"onUpdate:modelValue":i[3]||(i[3]=e=>P.value=e),density:"compact"},t,{"error-messages":D.value,"hide-details":"",label:"結束日期","prepend-inner-icon":"mdi-calendar",readonly:"",variant:"outlined"}),null,16,["modelValue","error-messages"])]),default:s(()=>[l(Z,{modelValue:d.value,"onUpdate:modelValue":[i[4]||(i[4]=t=>d.value=t),M],"first-day-of-week":1,min:V.value},null,8,["modelValue","min"])]),_:1},8,["modelValue"])])]),_:1}),l(z,{class:"pa-4",cols:"12",md:"6"},{default:s(()=>[l(q,{modelValue:f.value,"onUpdate:modelValue":i[6]||(i[6]=t=>f.value=t),density:"compact",flat:"","hide-details":"",placeholder:"搜尋商品","prepend-inner-icon":"mdi-magnify",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),l(B)]))}},Fe=ee(Be,[["__scopeId","data-v-35ae6ddc"]]),qe={class:"position-sticky top-0 bg-surface"},Ne={class:"d-flex align-center justify-space-between pa-5"},He={class:"d-flex align-center text-h6"},We={class:"d-flex align-center flex-wrap"},Qe={key:1,class:"mobile-orders"},Xe={class:"d-flex justify-space-between align-center"},Ye={class:"font-weight-bold text-caption order-id"},Ze={class:"text-caption text-medium-emphasis"},Ge={class:"d-flex justify-end font-weight-bold"},Je={key:0,class:"text-center pa-4 text-medium-emphasis"},Ke={__name:"myOrder",setup(v){const I=J(),y=G(),{mobile:T}=we(),_=R(()=>T.value),p=m([]),n=m(""),u=t=>{h()},f=()=>{n.value="",h()},V=[{title:"訂單ID",key:"_id",align:"start"},{title:"訂單內容",key:"cart",sortable:!1,align:"start"},{title:"總費用",key:"totalPrice",value:t=>t.totalPrice},{title:"下單日期",key:"createdAt"},{title:"買家ID",key:"userId",align:"start",value:t=>{var e;return((e=t.user)==null?void 0:e.account)||""}},{title:"訂單狀態",key:"status",value:t=>"已接單"},{title:"操作",key:"action",sortable:!1}],d=R(()=>I.role==="seller"?V.filter(t=>["_id","cart","totalPrice","createdAt","userId","action"].includes(t.key)):V.filter(t=>["_id","cart","totalPrice","createdAt","status","action"].includes(t.key))),D=(t,e)=>t&&t.length>e?t.slice(0,Math.max(0,e))+"...":t,h=async()=>{try{const{data:t}=await Ce.getMy();p.value=t.result}catch(t){console.error("載入訂單失敗:",t),y({text:"無法載入訂單資料",snackbarProps:{color:"error"}})}},M=t=>t?t.totalPrice:0,$=R(()=>n.value?p.value.filter(t=>{const e=n.value.toLowerCase(),a=t.cart.some(r=>r.product.name.toLowerCase().includes(e));return t._id.toLowerCase().includes(e)||a}):p.value);ke(()=>{h()});const P=m(!1),b=m(null),g=t=>{b.value=t,P.value=!0},i=()=>{P.value=!1,h()};return(t,e)=>(c(),k(O,null,[l(F,{class:"text-text","no-gutters":""},{default:s(()=>[l(z,{cols:"12"},{default:s(()=>[o("div",qe,[o("div",Ne,[o("div",He,[l(A,null,{default:s(()=>e[2]||(e[2]=[x("mdi-cards-outline")])),_:1,__:[2]}),e[3]||(e[3]=o("div",{class:"ml-2"},"我的訂單",-1))]),o("div",We,[De(I).role==="seller"?(c(),U(C,{key:0,class:"pa-4 d-flex align-center mr-sm-2 mb-2 mb-sm-0",color:"secondary",variant:"outlined"},{default:s(()=>[l(A,null,{default:s(()=>e[4]||(e[4]=[x("mdi-finance")])),_:1,__:[4]}),e[5]||(e[5]=o("div",null,"收益明細",-1))]),_:1,__:[5]})):(c(),U(C,{key:1,class:"pa-4 d-flex align-center mr-sm-2 mb-2 mb-sm-0",color:"secondary",variant:"outlined"},{default:s(()=>[l(A,null,{default:s(()=>e[6]||(e[6]=[x("mdi-finance")])),_:1,__:[6]}),e[7]||(e[7]=o("div",null,"消費明細",-1))]),_:1,__:[7]})),l(C,{class:"pa-4 d-flex align-center",color:"secondary",variant:"outlined"},{default:s(()=>[l(A,null,{default:s(()=>e[8]||(e[8]=[x("mdi-bell-badge-outline")])),_:1,__:[8]}),e[9]||(e[9]=o("div",null,"訂單通知",-1))]),_:1,__:[9]})])]),l(B)]),l(Fe,{search:n.value,"onUpdate:search":e[0]||(e[0]=a=>n.value=a),onResetFilters:f,onSearch:u},null,8,["search"]),_.value?(c(),k("div",Qe,[(c(!0),k(O,null,E($.value,a=>(c(),U(Te,{key:a._id,"min-height":100,options:{threshold:.5},transition:"fade-transition"},{default:s(()=>[l(K,{class:"mb-1 rounded-0"},{default:s(()=>[l(H,null,{default:s(()=>[o("div",Xe,[o("div",Ye,"訂單ID: "+w(a._id),1),l(C,{color:"secondary",icon:"mdi-pencil",onClick:r=>g(a)},null,8,["onClick"])]),o("div",Ze," 下單日期: "+w(new Date(a.createdAt).toLocaleString()),1),l(B,{class:"my-2"}),(c(!0),k(O,null,E(a.cart,r=>(c(),k("div",{key:r.product._id,class:"d-flex justify-space-between"},[o("span",null,w(D(r.product.name,10)),1),o("span",null,"x "+w(r.quantity),1)]))),128)),l(B,{class:"my-2"}),o("div",Ge," 總費用: $ "+w(M(a)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),$.value.length===0?(c(),k("div",Je," 查無訂單 ")):W("",!0)])):(c(),U(Se,{key:0,headers:d.value,"item-value":"_id",items:p.value,"items-per-page-options":[{value:10,title:"10"},{value:25,title:"25"},{value:50,title:"50"},{value:-1,title:"全部"}],"no-data-text":"查無訂單",search:n.value},{"item.cart":s(({value:a})=>[(c(!0),k(O,null,E(a,r=>(c(),k("div",{key:r.product._id},w(D(r.product.name,10))+" x "+w(r.quantity),1))),128))]),"item.totalPrice":s(({value:a})=>[x(" $ "+w(a),1)]),"item.createdAt":s(({value:a})=>[x(w(new Date(a).toLocaleString()),1)]),"item.action":s(({item:a})=>[l(C,{color:"secondary",icon:"mdi-pencil",onClick:r=>g(a)},null,8,["onClick"])]),_:1},8,["headers","items","search"]))]),_:1})]),_:1}),b.value?(c(),U(je,{key:0,modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=a=>P.value=a),"order-id":b.value._id,"order-products":b.value.cart,onSubmitSuccess:i},null,8,["modelValue","order-id","order-products"])):W("",!0)],64))}},dt=ee(Ke,[["__scopeId","data-v-0dd7c44e"]]);export{dt as default};
