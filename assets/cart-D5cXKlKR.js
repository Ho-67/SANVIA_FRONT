import{aD as De,a1 as Ie,a2 as Se,g as O,aE as Re,h as M,aF as ge,a3 as Te,aG as ae,aH as Ee,a7 as ee,w as de,i as we,a9 as Me,Z as xe,b as g,v as o,aI as Z,F as $,ac as Fe,E as F,ae as he,aJ as Ae,aK as ze,aL as Ue,l as fe,aM as Be,_ as qe,k as Le,N as $e,ai as je,j as We,p as L,t as i,M as He,T as te,s as Ge,aN as Ke,o as _,V as ne,y as N,C as oe,x as re,I as ye,aO as Oe,a as ue,G as R,D as T,c as E,e as Ze,n as se,al as be,am as ce}from"./index-UV5Uae5u.js";import{o as Je}from"./order-C2BCQozo.js";import{V as ie}from"./VCheckbox-9ACNxAx8.js";import"./VCheckboxBtn-CT3Jqn2e.js";const Xe=50,Ye=500;function Qe(a){let{toggleUpDown:j}=a,f=-1,V=-1;De(s);function A(x){s(),d(x),window.addEventListener("pointerup",s),document.addEventListener("blur",s),f=window.setTimeout(()=>{V=window.setInterval(()=>d(x),Xe)},Ye)}function s(){window.clearTimeout(f),window.clearInterval(V),window.removeEventListener("pointerup",s),document.removeEventListener("blur",s)}function d(x){j(x==="up")}return{holdStart:A,holdStop:s}}const et=Se({controlVariant:{type:String,default:"default"},inset:Boolean,hideInput:Boolean,modelValue:{type:Number,default:null},min:{type:Number,default:Number.MIN_SAFE_INTEGER},max:{type:Number,default:Number.MAX_SAFE_INTEGER},step:{type:Number,default:1},precision:{type:Number,default:0},...ze(Ue(),["modelValue","validationValue"])},"VNumberInput"),_e=Ie()({name:"VNumberInput",props:{...et()},emits:{"update:focused":a=>!0,"update:modelValue":a=>!0},setup(a,j){let{slots:f}=j;const V=O(),{holdStart:A,holdStop:s}=Qe({toggleUpDown:p}),d=Re(a),x=M(()=>d.isDisabled.value||d.isReadonly.value),z=ge(a.focused);function P(n){let c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:a.precision;const w=c==null?String(n):n.toFixed(c);return z.value?Number(w).toString():w}const v=Te(a,"modelValue",null,n=>n??null,n=>n==null?n??null:ae(Number(n),a.min,a.max)),I=ge(null);Ee(()=>{z.value&&!x.value||(v.value==null?I.value=null:isNaN(v.value)||(I.value=P(v.value)))});const y=M({get:()=>I.value,set(n){n===null||n===""?(v.value=null,I.value=null):!isNaN(Number(n))&&Number(n)<=a.max&&Number(n)>=a.min&&(v.value=Number(n),I.value=n)}}),U=M(()=>x.value?!1:(v.value??0)+a.step<=a.max),W=M(()=>x.value?!1:(v.value??0)-a.step>=a.min),b=M(()=>a.hideInput?"stacked":a.controlVariant),H=ee(()=>b.value==="split"?"$plus":"$collapse"),J=ee(()=>b.value==="split"?"$minus":"$expand"),B=ee(()=>b.value==="split"?"default":"small"),l=ee(()=>b.value==="stacked"?"auto":"100%"),t={props:{onClick:k,onPointerup:h,onPointerdown:pe,onPointercancel:h}},r={props:{onClick:k,onPointerup:h,onPointerdown:ve,onPointercancel:h}};de(()=>a.precision,()=>ke()),we(()=>{le()});function e(n){if(n==null)return 0;const c=n.toString(),w=c.indexOf(".");return~w?c.length-w:0}function p(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;if(x.value)return;if(v.value==null){y.value=P(ae(0,a.min,a.max));return}let c=Math.max(e(v.value),e(a.step));a.precision!=null&&(c=Math.max(c,a.precision)),n?U.value&&(y.value=P(v.value+a.step,c)):W.value&&(y.value=P(v.value-a.step,c))}function m(n){var Q;if(!n.data)return;const c=n.target,{value:w,selectionStart:X,selectionEnd:Y}=c??{},S=w?w.slice(0,X)+n.data+w.slice(Y):n.data,q=Be(S,a.precision);/^-?(\d+(\.\d*)?|(\.\d+)|\d*|\.)$/.test(S)||(n.preventDefault(),c.value=q),a.precision!=null&&(((Q=S.split(".")[1])==null?void 0:Q.length)>a.precision&&(n.preventDefault(),c.value=q),a.precision===0&&S.includes(".")&&(n.preventDefault(),c.value=q))}async function u(n){["Enter","ArrowLeft","ArrowRight","Backspace","Delete","Tab"].includes(n.key)||n.ctrlKey||["ArrowDown","ArrowUp"].includes(n.key)&&(n.preventDefault(),le(),await fe(),n.key==="ArrowDown"?p(!1):p())}function k(n){n.stopPropagation()}function h(n){const c=n.currentTarget;c==null||c.releasePointerCapture(n.pointerId),n.preventDefault(),s()}function pe(n){const c=n.currentTarget;c==null||c.setPointerCapture(n.pointerId),n.preventDefault(),n.stopPropagation(),A("up")}function ve(n){const c=n.currentTarget;c==null||c.setPointerCapture(n.pointerId),n.preventDefault(),n.stopPropagation(),A("down")}function le(){if(x.value||!V.value)return;const n=V.value.value;n&&!isNaN(Number(n))?y.value=P(ae(Number(n),a.min,a.max)):y.value=null}function ke(){if(!x.value){if(v.value===null||isNaN(v.value)){y.value=null;return}y.value=a.precision==null?String(v.value):v.value.toFixed(a.precision)}}function Ne(){if(!x.value){if(v.value===null||isNaN(v.value)){y.value=null;return}y.value=v.value.toString()}}function Ve(){Ne()}function Pe(){le()}return Me(()=>{const{modelValue:n,...c}=xe.filterProps(a);function w(){return f.increment?o(he,{key:"increment-defaults",defaults:{VBtn:{disabled:!U.value,flat:!0,height:l.value,size:B.value,icon:H.value}}},{default:()=>[f.increment(t)]}):o(F,{"aria-hidden":"true","data-testid":"increment",disabled:!U.value,flat:!0,height:l.value,icon:H.value,key:"increment-btn",onClick:k,onPointerdown:pe,onPointerup:h,onPointercancel:h,size:B.value,tabindex:"-1"},null)}function X(){return f.decrement?o(he,{key:"decrement-defaults",defaults:{VBtn:{disabled:!W.value,flat:!0,height:l.value,size:B.value,icon:J.value}}},{default:()=>[f.decrement(r)]}):o(F,{"aria-hidden":"true","data-testid":"decrement",disabled:!W.value,flat:!0,height:l.value,icon:J.value,key:"decrement-btn",onClick:k,onPointerdown:ve,onPointerup:h,onPointercancel:h,size:B.value,tabindex:"-1"},null)}function Y(){return g("div",{class:"v-number-input__control"},[X(),o(Z,{vertical:b.value!=="stacked"},null),w()])}function S(){return!a.hideInput&&!a.inset?o(Z,{vertical:!0},null):void 0}const q=b.value==="split"?g("div",{class:"v-number-input__control"},[o(Z,{vertical:!0},null),w()]):a.reverse||b.value==="hidden"?void 0:g($,null,[S(),Y()]),Q=f["append-inner"]||q,me=b.value==="split"?g("div",{class:"v-number-input__control"},[X(),o(Z,{vertical:!0},null)]):a.reverse&&b.value!=="hidden"?g($,null,[Y(),S()]):void 0,Ce=f["prepend-inner"]||me;return o(xe,Fe({ref:V},c,{modelValue:y.value,"onUpdate:modelValue":C=>y.value=C,focused:z.value,"onUpdate:focused":C=>z.value=C,validationValue:v.value,onBeforeinput:m,onFocus:Ve,onBlur:Pe,onKeydown:u,class:["v-number-input",{"v-number-input--default":b.value==="default","v-number-input--hide-input":a.hideInput,"v-number-input--inset":a.inset,"v-number-input--reverse":a.reverse,"v-number-input--split":b.value==="split","v-number-input--stacked":b.value==="stacked"},a.class],style:a.style,inputmode:"decimal"}),{...f,"append-inner":Q?function(){var K;for(var C=arguments.length,G=new Array(C),D=0;D<C;D++)G[D]=arguments[D];return g($,null,[(K=f["append-inner"])==null?void 0:K.call(f,...G),q])}:void 0,"prepend-inner":Ce?function(){var K;for(var C=arguments.length,G=new Array(C),D=0;D<C;D++)G[D]=arguments[D];return g($,null,[me,(K=f["prepend-inner"])==null?void 0:K.call(f,...G)])}:void 0})}),Ae({},V)}}),tt={class:"d-flex align-center justify-center pt-4 px-4 text-onSecondary"},nt={class:"d-flex align-center justify-space-between"},lt={key:0,class:"pa-md-4"},at={key:1,class:"text-grey font-weight-bold"},ot={key:2,class:"text-caption text-red ml-2"},rt={class:"text-caption text-nav"},ut={key:1,class:"pa-2"},st={key:1,class:"text-grey font-weight-bold text-subtitle-2 d-block mb-1 text-truncate"},ct={class:"text-caption text-nav mb-2"},it={class:"d-flex flex-nowrap"},dt={class:"text-primary"},ft={__name:"cart",setup(a){const{mdAndUp:j}=Le(),f=$e(),V=je(),A=Ge(),s=O([]),d=O([]),x=O(!1),z=O([]),P=()=>{for(const l of z.value){if(!l)continue;const t=l.parentElement;if(!t)continue;l.style.fontSize="";const r=Number.parseFloat(window.getComputedStyle(l).fontSize);if(t.clientWidth>0&&l.scrollWidth>t.clientWidth){const e=t.clientWidth/l.scrollWidth,p=Math.max(100,r*e);l.style.fontSize=`${p}px`}}};we(()=>{fe(P),window.addEventListener("resize",P)}),de(s,()=>{fe(P)},{deep:!0}),We(()=>{window.removeEventListener("resize",P)});const v=l=>{var t;return l!=null&&l.diceRollMultiplier?Math.round(l.product.price*l.diceRollMultiplier):((t=l==null?void 0:l.product)==null?void 0:t.price)||"0"},I=async()=>{var l,t;try{const{data:r}=await te.getCart(),e=r.result||[],p=await Promise.all(e.map(async m=>{var u;if((u=m.product)!=null&&u.roll)try{const{data:k}=await te.getDiceRoll(m.product._id);m.diceRollMultiplier=k.result.multiplier}catch{m.diceRollMultiplier=void 0}else m.diceRollMultiplier=void 0;return m}));s.value=p,d.value=[]}catch(r){console.error(r),f({text:((t=(l=r==null?void 0:r.response)==null?void 0:l.data)==null?void 0:t.message)||"無法載入購物車資料，請稍後再試",snackbarProps:{color:"error"}})}};I();const y=async(l,t,r)=>{var e,p,m;if(!((e=t==null?void 0:t.product)!=null&&e._id))return f({text:"此商品無法更新",snackbarProps:{color:"error"}}),s.value[r]&&(s.value[r].quantity=t.quantity),!1;if(l<0)return!1;try{const u=l-t.quantity,{data:k}=await te.cart({product:t.product._id,quantity:u});return l<=0?(s.value.splice(r,1),d.value=d.value.filter(h=>h!==t._id)):s.value[r]&&(s.value[r].quantity=l),V.cartTotal=k.result,!0}catch(u){return console.error(u),f({text:((m=(p=u==null?void 0:u.response)==null?void 0:p.data)==null?void 0:m.message)||"更新購物車失敗",snackbarProps:{color:"error"}}),!1}},U=async l=>{const t=s.value[l];if(!t)return;await y(0,t,l)&&f({text:"已成功刪除商品",snackbarProps:{color:"success"}})},W=async()=>{var l,t;try{if(d.value.length===0)return;const e=d.value.map(p=>s.value.find(m=>m._id===p)).filter(Boolean).map(p=>te.cart({product:p.product._id,quantity:-p.quantity}));await Promise.all(e),await I(),f({text:"已成功刪除選取商品",snackbarProps:{color:"success"}})}catch(r){console.error(r),f({text:((t=(l=r==null?void 0:r.response)==null?void 0:l.data)==null?void 0:t.message)||"刪除失敗，請稍後再試",snackbarProps:{color:"error"}})}},b=l=>{l.target.checked?d.value=s.value.map(r=>r._id):d.value=[]};de(d,l=>{x.value=l.length===s.value.length&&s.value.length>0});const H=M(()=>s.value.reduce((l,t)=>{var r;if(d.value.includes(t._id)&&((r=t==null?void 0:t.product)!=null&&r.sell)){const e=t.diceRollMultiplier?Math.round(t.product.price*t.diceRollMultiplier):t.product.price;return l+e*t.quantity}return l},0)),J=M(()=>s.value.length===0||d.value.length===0?!0:d.value.some(l=>{var r;const t=s.value.find(e=>e._id===l);return!((r=t==null?void 0:t.product)!=null&&r.sell)})),B=async()=>{var l,t;try{const r=d.value.map(e=>{const p=s.value.find(m=>m._id===e);return{product:p.product._id,quantity:p.quantity,multiplier:p.diceRollMultiplier||1}});await Je.create({cart:r,totalPrice:H.value}),V.clearCart(),A.push("/product"),f({text:"結帳成功",snackbarProps:{color:"success"}})}catch(r){console.error(r),f({text:((t=(l=r==null?void 0:r.response)==null?void 0:l.data)==null?void 0:t.message)||"結帳失敗",snackbarProps:{color:"error"}})}};return(l,t)=>{const r=Ke("router-link");return _(),L(He,{class:"my-4 mx-0 pa-md-6 pa-2 text-text",fluid:""},{default:i(()=>[o(ne,{"no-gutters":""},{default:i(()=>[o(N,{cols:"12"},{default:i(()=>[o(oe,{class:"rounded-t-pill px-4 text-text",color:"section",flat:""},{default:i(()=>[g("div",tt,[o(re(ye),{height:"24",icon:"streamline-freehand:e-commerce-cart-vr"}),t[3]||(t[3]=g("span",{class:"text-h6 ml-1 font-weight-bold"},"購物車商品",-1)),o(re(ye),{height:"24",icon:"streamline-freehand:cash-payment-bag-1"})]),g("div",nt,[o(ie,{modelValue:x.value,"onUpdate:modelValue":t[0]||(t[0]=e=>x.value=e),color:"onSecondary","hide-details":"",label:"全選",onChange:b},null,8,["modelValue"]),o(Oe,null,{default:i(()=>[d.value.length>0?(_(),L(F,{key:0,color:"onSecondary",variant:"text",onClick:W},{default:i(()=>[R(" 刪除選取 ("+T(d.value.length)+") ",1)]),_:1})):ue("",!0)]),_:1})])]),_:1})]),_:1}),o(N,{cols:"12"},{default:i(()=>[s.value.length>0?(_(!0),E($,{key:0},Ze(s.value,(e,p)=>{var m;return _(),E($,{key:e._id},[g("div",{class:se(["cart-item",{"selected-item":d.value.includes(e._id),"disabled-item":!((m=e==null?void 0:e.product)!=null&&m.sell)}])},[re(j)?(_(),E("div",lt,[o(ne,{align:"center",justify:"space-between"},{default:i(()=>[o(N,{class:"d-flex align-center flex-grow-1",cols:"12",md:"auto"},{default:i(()=>{var u,k;return[o(ie,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=h=>d.value=h),class:"mr-md-4",color:"primary","hide-details":"",value:e._id},null,8,["modelValue","value"]),o(be,{class:"cursor-pointer mr-4",rounded:"0",size:"80",onClick:h=>(e==null?void 0:e.product)&&l.$router.push("/product/"+e.product._id)},{default:i(()=>{var h;return[o(ce,{cover:"",src:((h=e==null?void 0:e.product)==null?void 0:h.image)||""},null,8,["src"])]}),_:2},1032,["onClick"]),g("div",null,[e!=null&&e.product?(_(),L(r,{key:0,class:se(["text-decoration-none font-weight-bold text-truncate d-block product-link",(u=e==null?void 0:e.product)!=null&&u.sell?"text-text":"text-grey text-decoration-line-through"]),to:"/product/"+e.product._id},{default:i(()=>[R(T(e.product.name),1)]),_:2},1032,["class","to"])):(_(),E("span",at,"商品不存在")),(k=e==null?void 0:e.product)!=null&&k.sell?ue("",!0):(_(),E("span",ot," (已下架) ")),g("div",rt," 單價: "+T(v(e))+" 幣 ",1)])]}),_:2},1024),o(N,{class:"d-flex align-center justify-end mt-4 mt-md-0",cols:"12",md:"auto"},{default:i(()=>[o(_e,{"control-variant":"split",density:"compact","hide-details":"",max:9999,min:0,"model-value":e.quantity,rules:[u=>u<=9999||"數量上限為9999"],style:{width:"160px"},variant:"outlined","onUpdate:modelValue":u=>y(u,e,p)},null,8,["model-value","rules","onUpdate:modelValue"]),o(F,{"aria-label":"移除商品",color:"secondary",icon:"mdi-delete",variant:"text",onClick:u=>U(p)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)])):(_(),E("div",ut,[o(ne,{align:"center",class:"flex-nowrap",justify:"space-between","no-gutters":""},{default:i(()=>[o(N,{class:"d-flex align-center",cols:"auto"},{default:i(()=>[o(ie,{modelValue:d.value,"onUpdate:modelValue":t[2]||(t[2]=u=>d.value=u),class:"mr-2",color:"primary","hide-details":"",value:e._id},null,8,["modelValue","value"]),o(be,{class:"cursor-pointer",rounded:"0",size:"64",onClick:u=>(e==null?void 0:e.product)&&l.$router.push("/product/"+e.product._id)},{default:i(()=>{var u;return[o(ce,{cover:"",src:((u=e==null?void 0:e.product)==null?void 0:u.image)||""},null,8,["src"])]}),_:2},1032,["onClick"])]),_:2},1024),o(N,{class:"px-1 flex-grow-1"},{default:i(()=>{var u;return[e!=null&&e.product?(_(),L(r,{key:0,class:se(["text-decoration-none font-weight-bold text-truncate d-block product-link ",(u=e==null?void 0:e.product)!=null&&u.sell?"text-text":"text-grey text-decoration-line-through"]),to:"/product/"+e.product._id},{default:i(()=>[R(T(e.product.name),1)]),_:2},1032,["class","to"])):(_(),E("span",st," 商品不存在 ")),g("div",ct,[t[4]||(t[4]=g("p",null,"單價:",-1)),g("span",it,T(v(e))+" 幣",1)])]}),_:2},1024),o(N,{class:"d-flex align-center justify-end",style:{maxWidth:"240px"}},{default:i(()=>[o(_e,{"control-variant":"split",density:"compact","hide-details":"",max:9999,min:0,"model-value":e.quantity,rules:[u=>u<=9999||"數量上限為9999"],style:{width:"160px"},variant:"outlined","onUpdate:modelValue":u=>y(u,e,p)},null,8,["model-value","rules","onUpdate:modelValue"]),o(F,{"aria-label":"移除商品",color:"secondary",icon:"mdi-delete",onClick:u=>U(p)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]))],2),p<s.value.length-1?(_(),L(Z,{key:0})):ue("",!0)],64)}),128)):(_(),L(oe,{key:1,class:"text-center py-12",color:"transparent",flat:""},{default:i(()=>[o(ce,{alt:"空購物車插圖",class:"mx-auto mb-4","max-width":"150",src:"https://cdn-icons-png.flaticon.com/512/1170/1170576.png",style:{filter:"sepia(0.6) saturate(0.4) hue-rotate(-15deg)"}}),t[6]||(t[6]=g("div",{class:"text-h6 text-nav mt-4"},"您的購物車是空的",-1)),o(r,{class:"text-body-2 text-highlight2 font-weight-medium text-decoration-none",to:"/product"},{default:i(()=>t[5]||(t[5]=[R(" 去逛逛，找到真正打動你的那一件吧！ ")])),_:1,__:[5]})]),_:1,__:[6]}))]),_:1}),o(N,{cols:"12"},{default:i(()=>[o(oe,{class:"pa-4",color:"surface",flat:""},{default:i(()=>[o(ne,{align:"center",justify:"end"},{default:i(()=>[o(N,null,{default:i(()=>[o(F,{color:"primary",size:"large",to:"/product",variant:"tonal"},{default:i(()=>t[7]||(t[7]=[R("再逛逛")])),_:1,__:[7]})]),_:1}),o(N,{class:"text-h6 font-weight-bold text-text",cols:"auto"},{default:i(()=>[R(" 總價值 ("+T(d.value.length)+" 件): ",1),g("span",dt,T(H.value)+" 幣",1)]),_:1}),o(N,{cols:"auto"},{default:i(()=>[o(F,{color:"accent",disabled:J.value,elevation:"2",size:"large",variant:"flat",onClick:B},{default:i(()=>t[8]||(t[8]=[R(" 結帳 ")])),_:1,__:[8]},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}}},xt=qe(ft,[["__scopeId","data-v-86ae2025"]]);export{xt as default};
